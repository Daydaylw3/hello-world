**目录**

------

[toc]

------

## 2.1 启动选顶和配置文件

> MySQL 的服务器程序和客户端程序也有很多设置项，比如对于 **MySQL 服务器程序**，我们可以指定允许同时连入的客户端数量、客户端和服务榕的通信方式、表的默认存储引擎、查询缓存的大小等信息

+ **启动选项(startup option)**：在程序启动时指定的设置项
  + 控制着程序启动后的行为；
  + 可以在命令行中指定；
  + 可以在配置文件中指定

> 下面以 `mysqld` 为例来演示

### 2.1.1 在命令行上使用选项

想在启动服务器程序时就禁止各客户端使用 `TCP/IP` 网络进行通信

```shell
mysqld --skip-networking
mysqld --skip_networking
```

> `*`如果选项名是由多个单词构成的，它们之间可以由短划线 `-` 连接，也可以使用下划线 `_` 连接

想改变表的默认存储引擎

```shell
mysqld --default-storage-engine=MyISAM
```

总结一下， 在启动服务器程序的命令行后边指定启动选项的通用格式

```shell
--启动造项1[=值1] --启动选项2[=值2] ... --启动选项n[=值n]
```

+ 不需要值的启动选项就不需要指定对应的值
+ 有值的启动选项需要注意，选项名、=、选项值之间不可以有空白字符

查看 `mysqld` 支持的启动选项有些特别

```shell
mysqld --verbose --help
```

**选项的长形式和短形式**

对于一些常用的选项提供了短形式

| 长形式     | 短形式 | 含义     |
| ---------- | ------ | -------- |
| --host     | -h     | 主机名   |
| --user     | -u     | 用户名   |
| --password | -p     | 密码     |
| --port     | -P     | 端口     |
| --version  | -V     | 版本信息 |

> 短形式选项名前只需一个短划线 `-` 前缀

+ 使用短形式选项时，选项名和选项值之间可以没有间隙， 也可以用空白字符隔开
+ `-p` 选项有些特殊， `-p` 和密码值之间不能有空白字
+ 选项名区分大小写

### 2.1.2 配置文件中使用选项

> 在命令行中设置的启动选项只对当次启动生效

#### 2.1.2.1 配置文件的路径

**Windows**

按照表所示的路径依次寻找

| 路径名                             | 备注                         |
| ---------------------------------- | ---------------------------- |
| `%WINDIR%\my.ini, %WINDIR%\my.cnf` |                              |
| `C:\my.ini, C:\my.cnf`             |                              |
| `BASEDIR\my.ini, BASEDIR\my.cnf`   |                              |
| `defaults-extra-file`              | 命令行指定的额外配置文件路径 |
| `%APPDATA%\MySQL\.mylogin.cnf`     | 登录路径选项（仅限客户端）   |

**注意**

+ 在给定的前 3 个路径中， 配置文件可以使用 `.ini` 的扩展名，也可以使用 `.cnf` 的扩展名

+ `%WINDIR%` 指的是你的机器上 Windows 目录的位置，通常是 `C:\``WINDOWS`， 如果不确定，可以使用 `echo %WINDIR%` 命令来查看

+ `BASEDIR` 指的是 MySQL 安装目录的路径

+ 第四个我们在命令行中可以这么写

  ```shell
  mysqld --defaults-extra-file=C:\Users\dayday\my_extra_file.txt
  ```

  这样 MySQL 服务器在启动时就可以额外在 `C:\Users\dayday\my_extra_file.txt` 路径下查找配置文件

+ `%APPDATA%` 表示Windows 应用程序数据目录的值，可以使用 `echo %APPDATA%` 命令查看

+ 最后一个名为 `.mylogin.cnf` 的配置文件有点儿特殊，它不是一个纯文本文件（其他的配置文件都是纯文本文件），而是使用 `mysql_config_editor` 实用程序创建的加密文件，这个文件只能包含一些在启动客户端程序时用于连接服务器的选项，包括 `host、user、password、port、socket`，而且它只能被客户端程序所使用

**类 UNIX 操作系统**

| 路径名                | 备注                             |
| --------------------- | -------------------------------- |
| `/etc/my.cnf`         |                                  |
| `/etc/mysql/my.cnf`   |                                  |
| `SYSCONFDIR/my.cnf`   |                                  |
| `$MYSQL_HOME/my.cnf`  | 特定于服务器的选项（仅限服务器） |
| `defaults-extra-file` | 命令行指定的额外配置文件路径     |
| `~/my.cnf`            | 特定于用户的选项                 |
| `~/.mylogin.cnf`      | 登录路径选项（仅限客户端）       |

**注意**

+ `SYSCONFDIR` 表示在使用 `CMake` 构建 MySQL 时使用 `SYSCONFDIR` 选项指定的目录
+ 如果使用 `mysqld_safe` 启动服务器程序，而且我们也没有主动设置这个 `MYSQL_HOME` 环境变量的值，那么这个环境交量的值将自动被设置为 MySQL 的安装目录

#### 2.1.2.2 配置文件的内容

配置文件中的启动选项被划分为若干个组，每个组有一个组名，用中括号 `[]` 扩起来

```
[server]
(具体的启动选项...)

[mysqld]
(具体的启动选项...)

[mysqld_safe]
(具体的启动选项...)

[client]
(具体的启动选项...)

[mysql]
(具体的启动选项...)

[mysqladmin]
(具体的启动选项...)
```

每个组下边可以定义若干个启动选项

```
[server]
option1            # 这是 option1，该选项不需要选项值
option2 = value2   # 这是 option2，该选项需要选项值
...
```

+ 只能使用长形式的选项，不许加 `--` 前缀
+ 每行只指定一个选项
+ `=` 周围可以有空白字符
+ 可以使用 `#` 来添加注释

在配置文件中，不同的选项组是给不同的程序使用的.如果选项组名称与程序名称相同，则组中的选项将专门应用于该程序，例如：

+ `[mysqld]` 组应用于 `mysqld` 服务器程序
+ `[mysql]` 组应用于 `mysql` 客户端程序

有两个选项组比较特别

+ `[server]` 组下面的启动选项将作用于所有的服务器程序
+ `[client]` 组下面的启动逃项将作用于所有的客户端程序

| 程序名         | 类别       | 能读取的组                         |
| -------------- | ---------- | ---------------------------------- |
| `mysqld`       | 启动服务器 | `[mysqld] [server]`                |
| `mysqld_safe`  | 启动服务器 | `[mysqld] [server] [mysqld_safe]`  |
| `mysql.server` | 启动服务器 | `[mysqld] [server] [mysql.server]` |
| `mysql`        | 启动客户端 | `[mysql] [client]`                 |
| `mysqladmin`   | 启动客户端 | `[mysqladmin] [client]`            |
| `mysqldump`    | 启动客户端 | `[mysqldump] [client]`             |

以 `macOS` 为例，在 `/etc/my.cnf` 配置文件里添加一些内容

```
[server]
default-storage-engine=MyISAM
```

重启 MySQL，创建表默认都是 `MyISAM`

#### 2.1.2.3 特定 MySQL 版本的专用选项组

可以在选项组的名称后加上特定的 MySQL 版本号，比如对于 `[mysqld]` 选项组来说，可以定义一个 `[mysqld-5.7]` 的选项组。意味着只有 `5.7` 版本的 MySQL才可以使用这个选项组中的选项

#### 2.1.2.4 配置文件的优先级

读取的顺序为按表格依次往下读，后面读取到的会覆盖前面读取的（如果有冲突的选项）

#### 2.1.2.5 同一个配置文件中多个组的优先级

同一个程序可以访问配置文件中的多个组，比如 `mysqld` 可以访问 `[mysqld]` 、`[server]` 组，如果在同一个配置文件中（比如 `~/my.cnf`） ， 在 `[mysqld]` 、`[server]` 组里出现了同样的启动选项，比如下面这样

```
[server]
default-storage-engine=InnoDB

[mysqld]
default-storage-engine=MyISAM
```

那么，将以最后一个出现的组中的启动选项为准。比如上面就以 `[mysqld]` 选项组中的配置项为准

#### 2.1.2.6 defaults-file 的使用

如果我们不想让 MySQL 在默认的路径下搜索配置文件，则可以在命令行指定 `defaults-file` 选项，比如下面这样（以类UNIX 系统为例）

```shell
mysqld --defaults-file=/tmp/myconfig.txt
```

这样一来，在程序启动时将只在 `/tmp/myconfig.txt` 路径下搜索配置文件，如果文件不存在或无法访问， 则会发生错误

> 注意 `defaults-extra-file` 和 `defaults-file` 的区别

### 2.1.3 在命令行和配置文件中启动选顶的区别

+ 同一个启动选项同时出现在命令行和配置文件，以命令行的为准

## 2.2 系统变量

### 2.2.1 系统变量简介

>  MySQL 服务器程序在运行过程中会用到许多影响程序行为的变量

+ **max_ connections**：允许同时连入的客户端数量
+ **default_storage_ engine**：表的默认存储引擎
+ **query_cache _size**：查询缓存的大小
+ 每个系统变量都有一个默认值，可以使用命令行或者配置文件中的选项在启动服务器时改变一些系统变量的值
+ 大多数系统变量的值也可以在程序运行过程中修改，而无须停止并重新启动服务器

### 2.2.2 查看系统变量

```mysql
SHOW VARIABLES [LIKE 匹配的模式];
```

### 2.2.3 设置系统变量

#### 2.2.3.1 通过启动选顶设置

+ 通过命令行添加启动选项
+ 通过配置文件添加启动选项

> 对于启动选项来说，如果启动项名由多个单词组成，各个单词之间用短划线 `-` 或者下划线 `_` 连接起来都可以，但是对于对应的系统变量来说， 各个单词之间必须使用下划线 `_` 连接起来

#### 2.2.3.2 服务器程序运行过程中设置

##### （1）设置不同作用范围的系统变量

> 对于同一个系统变量， 我们有时想让不同的客户端有不同的值

**问题**

+ 有一些系统变量并不是针对单个客户端的，公有的系统变量让某个客户端私有显然不合适
+ 一个新客户端连接到服务器时，与它对应的系统变量的值该怎么设置

**解决**

提出了系统变量的作用范围的概念。作用范围分为两种

+ **全局范围（GLOBAL）**：影响服务器的整体操作
+ **会话范围（SESSION）**：影响某个客户端连接的操作

服务器在启动时，会将每个全局变量初始化为其默认值；服务器还为每个连接的客户端维护一组会话变量，客户端的会话变量在连接时使用相应全局变量的当前值进行初始化。

在服务器程序运行期间通过客户端程序设置系统变量的语法：

```mysql
SET [GLOBAL|SESSION] 系统变量名 = 值;
```

或者

```mysql
SET [@@(GLOBAL|SESSION).]系统变量名 = 值;
```

**比如**

> 想让之后新连接到服务器的客户端都用 `MyISAM` 作为默认的存储引擎

```mysql
SET GLOBAL default_storage_engine = MyISAM;
SET @@GLOBAL.default_storage_engine = MyISAM;
```

> 如果只想对本客户端生效

```mysql
SET SESSION default_storage_engine = MyISAM;
SET @@SESSION.default_storage_engine = MyISAM;
SET default_storage_engine = MyISAM;
```

> 如果在设置系统变量的语句中省略了作用范围，**默认的作用范围就是 `SESSION`**

##### （2）查看不同作用范围的系统变量

可以在查看系统变量的语句中加上要查看哪个作用范围的系统变量的修饰符

```mysql
SHOW [GLOBAL|SESSION] VARIABLES [LIKE 匹配的模式];
```

**查看规则**

+ 如果使用 `GLOBAL` 修饰符，则显示全局系统变量的值，如果某个系统变作用范围，则不显示
+ 如果使用 `SESSION` 修饰符，则显示针对当前连接有效的系统变量值；如果某个系统变没有 `SESSION` 作用范围，则显示 `GLOBAL` 作用范围的值
+ 如果没写修饰符，则与使用 `SESSION` 修饰符效果一样

> **小贴士**：如呆某个客户端改变了某个系统变量在 `GLOBAL` 作用范围的值， 并不会影响该系统变量在当前已经连接的客户端作用范围为 `SESSION` 的值，只会影响后续追入的客户端作用范围为 `SESSION` 的值

##### （3）注意事项

+ 并不是所有的系统变量都具有 `GLOBAL` 和 `SESSION` 的作用范围
  + 有一些系统变量只具有 `GLOBAL` 作用范围，比如 `max_connections`
  + 有一些系统变量只具有 `SESSION` 作用范围，比如 `insert_id`（表示在对某个包含 `AUTO_INCREMENT` 列的表进行插入时，该列初始的值）
+ 有些系统变量是只读的，并不能设置值，比如 `version`（表示当前 MySQL 的版本）

#### 2.2.3.3 启动选项和系统变量的区别

> 启动选项是在程序启动时由用户传递的一些参数，而系统变量是影响服务器程序运行行为的变量

+ 大部分的系统变量都可以当作启动选项传入
+ 有些系统变量是在程序运行过程中自动生成的，不可以当作启动选项来设置，比如 `character_set_client`
+ 有些启动选项也不是系统变量，比如 `defaults-file`

## 2.3 状态变量

> 关于程序运行状态的变量；为了让我们更好地了解服务器程序的运行情况

+ 值只能由服务器程序自己来设置，不能人为设置
+ 状态变量也有 `GLOBAL` 和 `SESSION` 两个作用范围

**查看**

```mysql
SHOW [GLOBAL|SESSION] STATUS [LIKE 匹配的模式];
```

> 类似地，如果不写修饰符，则与使用 SESSION 修饰符效果一样

## 2.4 总结

+ 启动选项

  + 作用

  + 命令行中指定

    + 格式
    + 长短形式

  + 配置文件指定

    + 文件路径
    + 格式
+ 系统变量
  + 修改方式
  + 查看方式
+ 状态变量

  + 查看方式

------

[toc]