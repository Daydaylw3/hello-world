[toc]

------

## 8.1 数据库和文件系统的关系

InnoDB 和MyISAM 这两个存储引擎的数据是如何在文件系统中存储的

## 8.2 MySQL 数据目录

**数据目录**：MySQL 服务器程序在启动时， 会到文件系统的某个目录下加载一些数据，之后在运行过程中产生的数据也会存储到这个目录下的某些文件中

### 8.2.1 数据目录相安装目录的区别

### 8.2.2 如何确定MySQ L 中的数据目录

数据目录对应着一个系统变量 `datadir`

```mysql
mysql> show variables like 'datadir';
+---------------+------------------------+
| Variable_name | Value                  |
+---------------+------------------------+
| datadir       | /usr/local/mysql/data/ |
+---------------+------------------------+
1 row in set (0.20 sec)
```

## 8.3 数据目录的结构

包含我们创建的数据库、表、视图和触发器等用户数据。为了让程序更好地运行. MySQL 也会创建一些额外的数据

### 8.3.1 数据库在文件系统中的表示

创建一个数据库的时候，会对应数据目录下的一个子目录

+ 在数据目录下创建-个与数据库名同名的子目录(或者说是文件夹) ;
+ 在与该数据库名同名的子目录下创建一个名为 db.opt 的文件（包含了该数据库的一些属性，比如字符集和比较规则）

### 8.3.2 表在文件系统中的表示

我们的数据其实都是以记录的形式插入到表中的.每个袤的信息可以分为两种

+ 表结构的定义
+ 表中的数据

**表结构**：该袤的名称是啥、表里面有多少列、每个列的数据类型是啥、有啥约束条件和索引、用的是啥字符集和比较规则等各种信息。这些信息都体现在了我们的建表语句中。InnoDB 和MyISAM 这两种存储引擎都在数据目录下对应的数据库子目录中创建了一个专门用于描述表结构的文件：`表名.frm`

> MySQL 8 之后将 `frm` 合并到了 `ibd` 中，要查看 `frm` 可以使用命令
>
> ```
> ibd2sdi --dump-file=表名.txt 表名.ibd
> cat 表名.txt
> ```

#### 1. InnoDB 是如何存储表数据的

为了更好地管理这些页，innoDB 的提出了表空间( table space) 或者文件空间（file space）的概念

这个表空间是一个抽象的概念，它可以对应文件系统上一个或多个真实文件(不同表空间对应的文件数量可能不同)

每一个表空间可以被划分为很多个页， 表数据就存放在某个表空间下的某些页k

将表空间划分为几种不同的类型

##### （1）系统表空间（system tablespace）

lnnoDB 会在数据目录下创建一个名为 `ibdata1`，大小为12MB 的文件，这个文件就是对应的系统表空间在文件系统上的表示

这个文件是自扩展文件，也就是当不够用的时候它会自己增加文件大小

可以在MySQL 服务器启动时，配置对应的文件路径以及它们的大小

```
[server]
innodb_data_file_path=data1:512M;data2:512M:autoextend
```

```mysql
mysql> show variables like 'innodb_data_file_path';
+-----------------------+------------------------+
| Variable_name         | Value                  |
+-----------------------+------------------------+
| innodb_data_file_path | ibdata1:12M:autoextend |
+-----------------------+------------------------+
1 row in set (0.34 sec)
```

> 在MySQL 启动之后就会创建data! 和data2这两个各自512MB 大小的文件作为系统表空间。
>
> 其中的 `autoextend` 表明，如果这两个文件不够用，则会自动扩展data2文件的大小

可以不把系统表空间对应的文件路径配置到数据目录下， 甚至可以配置到单独的磁盘分区上，这时涉及的启动选项就是 `innodb_data_file_path` 和 `innodb_data_home_dir`

在一个MySQL 服务器中，系统表空间只有一份（从MySQL 5.5.7 到 MySQL5.6.5）

##### （2）独立表空间（file-per-table tablespace）

在 MySQL 5.6.6 以及之后的版本中. InnoDB 不再默认把各个袤的数据存储到系统表空间中，而是为每一个表建立一个独立表空间

创建了多少个衰，就有多少个独立表空间

在使用独立表空间来存储表数据时， 会在该表所属数据库对应的子目录下创建一个表示该独立表空间的文件，其文件名和表名相同，只不过添加了一个ibd 扩展名：`表名.ibd`

也可以自己指定是使用系统表空间还是独立表空间来存储数据，这个功能由启动选项 `innodb_file_per_table` 控制

```
[server]
innodb_file_per_table=0 # 0-使用系统表空间；1-使用独立表空间
```

`innodb_file_per_table` 只对新建的表起作用，对于已经分配了表空间的表并不起作用

把已经存储到系统表空间中的表转移到独立表空间

```mysql
alter table 表名 tablespace [=] innodb_file_per_table;
```

把已经存储到独立表空间的表转移到系统表空间

```mysl
alter table 表名 tablespace [=] innodb_system;
```

##### （3）其他类型的表空间

+ 通用表空间（general tablespace）
+ undo 表空间（undo tablespace）
+ 临时表空间（temporary tablespace）

#### 2. MyISAM 是如何存储表数据的

在文件系统中也是使用不同的文件来存储数据文件和索引文件

MyISAM 并没有什么表空间一说，表的数据和索引都存放到对应的数据库子目录下

在它所在数据库对应的目录下会为表创建下面这3 个文件

+ 表名.frm（MySQL 8 之后改为 表名.sdi）
+ 表名.MYD：表的数据文件，也就是插入的用户记录
+ 表名.MYI：表的索引文件

### 8.3.3 其他的文件

数据目录下还包含了一些确保程序更好运行的额外文件

+ **服务器进程文件**：服务器会把自己的进程ID 写入到这个文件中
+ **服务器日志文件**：比如常规的查询日志、错误日志、二进制日志、redo 日志等
+ **SSL 和 RSA 证书与密钥文件**：为了客户端和服务器安全通信而创建的一些文件

## 8.4 文件系统对数据库的影响

+ 数据库名称和表名称不得超过文件系统所允许的最大长度

+ 特殊字符的问题

  为了避免因为数据库名和表名出现某些特殊字符而造成文件系统不支持的情况，MySQL 会把数据库名和表名中所有除数字和拉丁字母以外的任何字符在文件名中都映射成 @ + 编码值的形式，并将其作为文件名

+ 文件长度受文件系统最大长度的限制

## 8.5 MySQL 系统数据库简介

MySQL 的几个系统数据库包含了MySQL 服务器运行过程中所需的一些信息以及一些运行状态信息

+ **mysql**：它存储了MySQL 的用户账户和权限信息、一些存储过程和事件的定义信息、一些运行过程中产生的日志信息、一些帮助信息以及时区信息等
+ **information_schema**：这个数据库保存着MySQL 服务器维护的所有其他数据库的信息，比如有哪些表、哪些视图、哪些触发器、哪些列、哪些索引等。这些信息并不是真实的用户数据，而是一些描述性信息，有时候也称之为元数据.
+ **performance_schema**：主要保存MySQL 服务器运行过程中的一些状态信息，算是对MySQL 服务器的一个性能监控。它包含的信息有统计最近执行了哪些语句，在执行过程的每个阶段都花费了多长时间，内存的使用情况等。
+ **sys**：这个数据库主要是通过视图的形式把 `information_schema` 和 `performance_schema` 结合起来，让开发人员更方便地了解MySQL 服务器的性能信息

## 8.6 总结



------

[toc]